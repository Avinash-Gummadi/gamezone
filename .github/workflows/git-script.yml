name: Auto-Merge to Master

on:
  push:
    branches:
      - gamecode
  pull_request:
    branches:
      - '*'
    types:
      - closed

jobs:
  auto_merge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Create Merge Request
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ "$GITHUB_REF" == "refs/heads/gamecode" ]; then
          # When a push occurs to the gamecode branch, create a pull request to merge it into master.
          TITLE="Auto-Merge from gamecode to master"
          BASE="master"
          HEAD="gamecode"
          BODY="This pull request is automatically generated."
          URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls"
          RESPONSE=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -d "{\"title\":\"$TITLE\",\"base\":\"$BASE\",\"head\":\"$HEAD\",\"body\":\"$BODY\"}" $URL)
          PR_URL=$(echo $RESPONSE | jq -r .html_url)
          echo "Created pull request: $PR_URL"
        fi